name: Scheduled Tests

on:
  schedule:
    # Run every day at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  scheduled-tests:
    name: Run Scheduled Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Run tests with coverage
        id: tests
        run: npm run test:coverage
        continue-on-error: true

      - name: Run type check
        id: typecheck
        run: npm run type-check
        continue-on-error: true

      - name: Run linting
        id: lint
        run: npm run lint
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: test-results-${{ github.run_number }}
          path: |
            coverage/
            coverage.json
          retention-days: 14

      - name: Create summary
        if: always()
        run: |
          echo "### ðŸ“Š Scheduled Test Run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Results:**" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.tests.outcome }}" = "success" ]; then
            echo "- âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Tests failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.typecheck.outcome }}" = "success" ]; then
            echo "- âœ… Type check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Type check failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.lint.outcome }}" = "success" ]; then
            echo "- âœ… Linting passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Linting failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const title = 'ðŸš¨ Scheduled Test Failure - ' + new Date().toISOString().split('T')[0];
            const body = `## Scheduled Test Failure

            The scheduled tests failed on ${new Date().toUTCString()}.

            **Run Details:**
            - Workflow Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            - Commit: ${context.sha}

            **Results:**
            - Tests: ${{ steps.tests.outcome }}
            - Type Check: ${{ steps.typecheck.outcome }}
            - Linting: ${{ steps.lint.outcome }}

            Please investigate the test failures and ensure the codebase is healthy.

            ---
            *This issue was automatically created by the scheduled tests workflow.*`;

            // Check if there's already an open issue for today
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'scheduled-tests',
              per_page: 10
            });

            const today = new Date().toISOString().split('T')[0];
            const existingIssue = issues.data.find(issue => issue.title.includes(today));

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['scheduled-tests', 'bug']
              });
            }

  dependency-check:
    name: Check for Outdated Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for outdated packages
        run: npm outdated || true

      - name: Create outdated packages summary
        run: |
          echo "### ðŸ“¦ Dependency Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          npm outdated || echo "All packages are up to date!" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
